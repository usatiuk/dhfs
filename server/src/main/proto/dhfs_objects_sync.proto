syntax = "proto3";

option java_multiple_files = true;
option java_package = "com.usatiuk.dhfs.objects.repository";
option java_outer_classname = "DhfsObjectSyncApi";

package dhfs.objects.sync;

service DhfsObjectSyncGrpc {
  rpc GetObject (GetObjectRequest) returns (GetObjectReply) {}
  rpc CanDelete (CanDeleteRequest) returns (CanDeleteReply) {}
  rpc GetIndex (GetIndexRequest) returns (IndexUpdatePush) {}
  rpc IndexUpdate (IndexUpdatePush) returns (IndexUpdateReply) {}

  rpc Ping (PingRequest) returns (PingReply) {}
}

message PingRequest {
  string selfUuid = 1;
}

message PingReply {
  string selfUuid = 1;
}

message ObjectChangelogEntry {
  string host = 1;
  uint64 version = 2;
}

message ObjectChangelog {
  repeated ObjectChangelogEntry entries = 1;
}

message ObjectHeader {
  string name = 2;
  ObjectChangelog changelog = 5;
  optional bytes pushedData = 6;
}

message ApiObject {
  ObjectHeader header = 1;
  bytes content = 2;
}

message GetObjectRequest {
  string selfUuid = 10;

  string name = 2;
}

message GetObjectReply {
  string selfUuid = 10;

  ApiObject object = 1;
}

message CanDeleteRequest {
  string selfUuid = 10;

  string name = 2;
}

message CanDeleteReply {
  string selfUuid = 10;
  string objName = 1;
  bool deletionCandidate = 2;
  optional  string referent = 3;
}

message GetIndexRequest {
  string selfUuid = 10;
}

message IndexUpdatePush {
  string selfUuid = 10;

  repeated ObjectHeader header = 1;
}

message IndexUpdateError {
  string object_name = 1;
  string error = 2;
}

message IndexUpdateReply {
  string selfUuid = 10;

  repeated IndexUpdateError errors = 1;
}